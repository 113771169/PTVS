<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <Import Project="$(WixTargetsPath)" />

  <!-- Identifies the files that need signing. -->
  <Target Name="SignMsi">
    <ItemGroup Condition="$(SignAssembly)">
      <FilesToSign Include="@(SignMsi)">
        <Authenticode>MicrosoftSHA1</Authenticode>
      </FilesToSign>
    </ItemGroup>
  </Target>

  <Target Name="CompileFilesProj"
          BeforeTargets="BeforeBuild"
          Condition="'@(FilesProj)' != ''">
    <MSBuild Projects="%(FilesProj.FullPath)"
             Properties="VSTarget=$(VSTarget);Configuration=$(Configuration);TargetPath=$(IntermediateOutputPath)%(FilesProj.FileName).wxs" />
    <ItemGroup>
      <Compile Include="@(FilesProj->'$(IntermediateOutputPath)%(FileName).wxs')" />
    </ItemGroup>
  </Target>
  
  <!--
  Set the bind paths in this order
  
    1. Signed binaries (if any)
    2. Output directory (for explicit project references)
    3. Each project output directory (for implicit project references)
    4. Setup output directory (for merge modules)
  -->
  <Target Name="_SetBindInputPaths" BeforeTargets="Link">
    <PropertyGroup>
      <CopyOutputsToPath Condition="'$(CopyOutputsToPath)' != '' and !HasTrailingSlash($(CopyOutputsToPath))">$(CopyOutputsToPath)\</CopyOutputsToPath>
    </PropertyGroup>
    <ItemGroup>
      <LinkerBindInputPaths Include="$(SignedBinariesPath)" Condition="'$(SignedBinariesPath)' != ''">
        <BindName>bin</BindName>
      </LinkerBindInputPaths>
      <LinkerBindInputPaths Include="$(BuildOutputRoot)binaries" Condition="'$(SignedBinariesPath)' == ''">
        <BindName>bin</BindName>
      </LinkerBindInputPaths>
      <LinkerBindInputPaths Include="$(OutputPath)" />
    </ItemGroup>
  </Target>
</Project>
